# Beezig GitLab CI Configuration
# Copyright (C) 2020  Beezig Team
---

image: openjdk:8-alpine

include:
- template: Security/SAST.gitlab-ci.yml

variables:
    GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"

cache: &global_cache
  key: ${CI_COMMIT_SHA}
  paths:
     - .gradle/wrapper
     - .gradle/caches
     - build
  policy: pull

stages:
    - build
    - test
    - deploy

sast:
    needs: [build]
    before_script:
        - apk add git
    variables:
        SAST_DEFAULT_ANALYZERS: spotbugs
    stage: test
    cache:
        <<: *global_cache

build:
    stage: build
    before_script:
        - apk add git
    script:
        - ./gradlew build
    cache:
        <<: *global_cache
        policy: pull-push

deploy artifacts:
    needs: [build]
    stage: deploy
    image: alpine:latest
    script: # Placeholder
        - pwd
    artifacts:
        paths:
            - build/libs/*.jar
        expire_in: 1 week
    cache:
        <<: *global_cache

deploy version:
    needs: [build]
    stage: deploy
    before_script:
        - apk add openssh git jq bash coreutils curl
    script:
        - chmod go= "$DEPLOY_KEY"
        - mkdir -p ~/.ssh/ || true
        - ssh-keyscan -H 'gitlab.com' >> ~/.ssh/known_hosts
        - ssh-agent bash -c "ssh-add \"$DEPLOY_KEY\"; git clone git@gitlab.com:Beezig/version.git ; version/update-version.sh --module beezig --type beta --version 7.0.0 version/beta.json ; cd version; git add beta.json ; git -c 'user.name=GitLab Deploy' -c 'user.email=noreply@gitlab.com' commit -m 'Update beta version' ; git push origin master"
        - curl -X POST -F token=$BEEZIGLABY_TRIGGER -F ref=rewrite https://gitlab.com/api/v4/projects/11233515/trigger/pipeline
    only:
        refs:
            - rewrite-2020
...
